#!/usr/bin/env perl

my $testname = $ARGV[0];
my $outputdir = $ARGV[1];
my $testdir = $ARGV[2];
my $searchdir = ".";

my $dupkeys = "$searchdir/dupkeys.tmp";
system("find $searchdir -name \\$testname.perfkeys > $dupkeys");
open DUPLICATES, "$dupkeys" or die "can't open $dupkeys $!";
my @duplicates = <DUPLICATES>;
system("rm $dupkeys");
exit &getNumDuplicates;

sub getNumDuplicates {
    my $result = $#duplicates;
    if ($#duplicates > 0) {
        print "[Error: found $#duplicates .perfkey files:";
        foreach my $duplicate(@duplicates) {
            chomp($duplicate);
            print " $duplicate";
        }
        print "]\n";
    } elsif ($#duplicates < 0) {
	my @perfnamepieces = (split /\./, $testname);

	my $dupkeys2 = "$searchdir/dupkeys.tmp";
	system("find $searchdir -name \\@perfnamepieces[0].perfkeys > $dupkeys2");
	open DUPLICATES, "$dupkeys2" or die "can't open $dupkeys2 $!";
	my @duplicates2 = <DUPLICATES>;
	system("rm $dupkeys2");
	
	if ($#duplicates2 > 0) {
	    print "[Error: found $#duplicates .perfkey files:";
	    foreach my $duplicate(@duplicates) {
	        chomp($duplicate);
	        print " $duplicate";
            }
            print "]\n";
	} elsif ($#duplicates2 < 0) {
	    print "[Error finding @perfnamepieces[0].perfkeys or $testname[0].perfkeys]\n";
	} 
	#print "[$testname.perfkeys not found, but found @perfnamepieces[0].perfkeys and no duplicates]\n"; 
	$result = $#duplicates2;

    }
    return $result;
}

