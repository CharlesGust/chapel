#!/bin/bash -l
# Run this from the examples directory

PES=""

if [[ $# -ge 1 ]] ; then
   for pe in "$@" ; do
       PES=${PES}" "$pe
   done
else
   PES="gnu pgi intel cray"
fi

TESTS="hpcc/stream"

old=`module list 2>&1 | grep PrgEnv | awk '{ print $NF }' | awk -F / '{ print $1 }'`

echo $old

for pe in $PES ; do
    new="PrgEnv-"$pe
    echo "***"
    echo "*** Testing $new"
    echo "***"
    module swap $old $new
    tnew=`module list 2>&1 | grep PrgEnv | awk '{ print $NF }' | awk -F / '{ print $1 }'`
    if [ "$tnew" != $new ]; then
       echo "***"
       echo "*** MODULE NOT FOUND: $new"
       echo "***"
       continue
    fi
    module show $new
    echo "***"
    echo "*** Building examples"
    echo "***"
    make clean
    make
    echo "***"
    echo "*** Running hello6-taskpar-dist"
    ./hello6-taskpar-dist `cat hello6-taskpar-dist.execopts` -nl `cat NUMLOCALES` -q | sort - | diff hello6-taskpar-dist.good -
    if [ $? != 0 ] ; then
       echo "***"
       echo "*** TEST FAILED: $t"
       echo "***"
    fi
    # no PREDIFFS
    for t in $TESTS ; do
	echo "*** Running $t"
	./$t `cat $t.execopts` -nl `cat NUMLOCALES` -q | diff $t.good -
	if [ $? != 0 ] ; then
	    echo "***"
	    echo "*** TEST FAILED: $t"
	    echo "***"
	fi
    done
    old=$new
done
